

def ensure_single_user(app: FastAPI) -> None:
    """Ensure exactly one user exists for single-user mode."""
    import sys
    from utils.database_session_manager import get_shared_session_manager

    session_manager = get_shared_session_manager()

    with session_manager.get_admin_session() as session:
        result = session.execute_single("SELECT COUNT(*) as count FROM users")
        user_count = result['count']

        if user_count == 0:
            import uuid
            import secrets

            user_id = str(uuid.uuid4())
            default_email = "user@localhost"

            session.execute_update("""
                INSERT INTO users (id, email, is_active, memory_manipulation_enabled)
                VALUES (%(id)s, %(email)s, true, true)
            """, {'id': user_id, 'email': default_email})

            # Create the continuum (normally done during signup flow)
            continuum_id = str(uuid.uuid4())
            session.execute_update("""
                INSERT INTO continuums (id, user_id, metadata, created_at, updated_at)
                VALUES (%(id)s, %(user_id)s, '{}'::jsonb, NOW(), NOW())
            """, {'id': continuum_id, 'user_id': user_id})

            # Prepopulate with starter messages (ported from auth.database.prepopulate_new_user)
            import json
            from utils.timezone_utils import utc_now

            # Message 1: Beginning marker
            msg1_id = str(uuid.uuid4())
            session.execute_update("""
                INSERT INTO messages (id, continuum_id, user_id, role, content, metadata, created_at)
                VALUES (%(id)s, %(continuum_id)s, %(user_id)s, 'user', %(content)s, %(metadata)s, NOW())
            """, {
                'id': msg1_id,
                'continuum_id': continuum_id,
                'user_id': user_id,
                'content': '.. this is the beginning of the conversation. there are no messages older than this one ..',
                'metadata': json.dumps({'system_generated': True})
            })

            # Message 2: Active segment sentinel
            segment_id = str(uuid.uuid4())
            segment_metadata = {
                'is_segment_boundary': True,
                'status': 'active',
                'segment_id': segment_id,
                'segment_start_time': utc_now().isoformat(),
                'segment_end_time': utc_now().isoformat(),
                'segment_turn_count': 1,  # Required for increment_segment_turn()
                'tools_used': [],
                'memories_extracted': False,
                'domain_blocks_updated': False
            }
            msg2_id = str(uuid.uuid4())
            session.execute_update("""
                INSERT INTO messages (id, continuum_id, user_id, role, content, metadata, created_at)
                VALUES (%(id)s, %(continuum_id)s, %(user_id)s, 'assistant', %(content)s, %(metadata)s, NOW() + interval '100 milliseconds')
            """, {
                'id': msg2_id,
                'continuum_id': continuum_id,
                'user_id': user_id,
                'content': '[Segment in progress]',
                'metadata': json.dumps(segment_metadata)
            })

            logger.info(f"Created user {user_id} with continuum {continuum_id} and starter messages")

            # Prepopulate default domaindoc
            from auth.prepopulate_domaindoc import prepopulate_user_domaindoc
            prepopulate_user_domaindoc(user_id)
            logger.info(f"Prepopulated domaindoc for user {user_id}")

            api_key = f"mira_{secrets.token_urlsafe(32)}"

            try:
                from clients.vault_client import _ensure_vault_client
                vault_client = _ensure_vault_client()
                # Use patch to add mira_api without overwriting anthropic_key/provider_key
                vault_client.client.secrets.kv.v2.patch(
                    path='mira/api_keys',
                    secret=dict(mira_api=api_key)
                )
            except Exception as e:
                logger.warning(f"Could not store key in Vault: {e}")

            app.state.single_user_id = user_id
            app.state.user_email = default_email
            app.state.api_key = api_key

            print(f"\n{'='*60}")
            print("MIRA Ready - Single-User OSS Mode")
            print(f"{'='*60}")
            print(f"User: {default_email}")
            print(f"API Key: {api_key}")
            print(f"{'='*60}\n")
            return

        elif user_count > 1:
            print(f"\nERROR: Found {user_count} users")
            print("MIRA OSS operates in single-user mode only.")
            sys.exit(1)

        user = session.execute_single("SELECT id, email FROM users LIMIT 1")
        app.state.single_user_id = str(user['id'])
        app.state.user_email = user['email']

        try:
            from clients.vault_client import _ensure_vault_client
            vault_client = _ensure_vault_client()
            secret_data = vault_client.client.secrets.kv.v2.read_secret_version(
                path='mira/api_keys'
            )
            api_key = secret_data['data']['data'].get('mira_api')
            app.state.api_key = api_key

            print(f"\nMIRA Ready - User: {user['email']}\n")
        except Exception as e:
            logger.error(f"Failed to retrieve API key from Vault: {e}")
            print("\nERROR: Could not retrieve API key from Vault")
            sys.exit(1)

